{"ast":null,"code":"import _regeneratorRuntime from\"/home/ctapang/dapp-scaffold/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/ctapang/dapp-scaffold/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"/home/ctapang/dapp-scaffold/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/home/ctapang/dapp-scaffold/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useCallback,useContext,useEffect,useState}from\"react\";import{MINT_TO_MARKET}from\"./../models/marketOverrides\";import{STABLE_COINS}from\"./../utils/utils\";import{useConnectionConfig}from\"./connection\";import{cache,getMultipleAccounts}from\"./accounts\";import{Market,MARKETS,Orderbook,TOKEN_MINTS}from\"@project-serum/serum\";import{Connection,PublicKey}from\"@solana/web3.js\";import{useMemo}from\"react\";import{EventEmitter}from\"./../utils/eventEmitter\";import{DexMarketParser}from\"./../models/dex\";import{useUserAccounts}from\"../hooks\";export var BONFIDA_POOL_INTERVAL=30*60000;// 30 min\nvar REFRESH_INTERVAL=30000;var MarketsContext=React.createContext(null);var marketEmitter=new EventEmitter();export function MarketProvider(_ref){var _ref$children=_ref.children,children=_ref$children===void 0?null:_ref$children;var _useConnectionConfig=useConnectionConfig(),endpoint=_useConnectionConfig.endpoint;var accountsToObserve=useMemo(function(){return new Map();},[]);var _useState=useState([]),_useState2=_slicedToArray(_useState,2),marketMints=_useState2[0],setMarketMints=_useState2[1];var _useUserAccounts=useUserAccounts(),userAccounts=_useUserAccounts.userAccounts;var connection=useMemo(function(){return new Connection(endpoint,\"recent\");},[endpoint]);var marketByMint=useMemo(function(){return _toConsumableArray(new Set(marketMints).values()).reduce(function(acc,key){var mintAddress=key;var SERUM_TOKEN=TOKEN_MINTS.find(function(a){return a.address.toBase58()===mintAddress;});var marketAddress=MINT_TO_MARKET[mintAddress];var marketInfo=MARKETS.filter(function(m){return!m.deprecated;}).find(function(m){return m.name===\"\".concat(SERUM_TOKEN===null||SERUM_TOKEN===void 0?void 0:SERUM_TOKEN.name,\"/USDC\")||m.name===\"\".concat(SERUM_TOKEN===null||SERUM_TOKEN===void 0?void 0:SERUM_TOKEN.name,\"/USDT\")||m.address.toBase58()===marketAddress;});if(marketInfo){acc.set(mintAddress,{marketInfo:marketInfo});}return acc;},new Map());},[marketMints]);useEffect(function(){var timer=0;var updateData=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return refreshAccounts(connection,_toConsumableArray(accountsToObserve.keys()));case 2:marketEmitter.raiseMarketUpdated(new Set(_toConsumableArray(marketByMint.keys())));timer=window.setTimeout(function(){return updateData();},REFRESH_INTERVAL);case 4:case\"end\":return _context.stop();}}},_callee);}));return function updateData(){return _ref2.apply(this,arguments);};}();var initalQuery=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var reverseSerumMarketCache,allMarkets,toQuery;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:reverseSerumMarketCache=new Map();_toConsumableArray(marketByMint.keys()).forEach(function(mint){var m=marketByMint.get(mint);if(m){reverseSerumMarketCache.set(m.marketInfo.address.toBase58(),mint);}});allMarkets=_toConsumableArray(marketByMint.values()).map(function(m){return m.marketInfo.address.toBase58();});_context2.next=5;return getMultipleAccounts(connection,// only query for markets that are not in cahce\nallMarkets.filter(function(a){return cache.get(a)===undefined;}),\"single\").then(function(_ref4){var keys=_ref4.keys,array=_ref4.array;allMarkets.forEach(function(){});return array.map(function(item,index){var marketAddress=keys[index];var mintAddress=reverseSerumMarketCache.get(marketAddress);if(mintAddress){var market=marketByMint.get(mintAddress);if(market){var id=market.marketInfo.address;cache.add(id,item,DexMarketParser);}}return item;});});case 5:toQuery=new Set();allMarkets.forEach(function(m){var market=cache.get(m);if(!market){return;}var decoded=market;if(!cache.get(decoded.info.baseMint)){toQuery.add(decoded.info.baseMint.toBase58());}if(!cache.get(decoded.info.baseMint)){toQuery.add(decoded.info.quoteMint.toBase58());}toQuery.add(decoded.info.bids.toBase58());toQuery.add(decoded.info.asks.toBase58());});_context2.next=9;return refreshAccounts(connection,_toConsumableArray(toQuery.keys()));case 9:marketEmitter.raiseMarketUpdated(new Set(_toConsumableArray(marketByMint.keys())));// start update loop\nupdateData();case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function initalQuery(){return _ref3.apply(this,arguments);};}();initalQuery();return function(){window.clearTimeout(timer);};},[marketByMint,accountsToObserve,connection]);var midPriceInUSD=useCallback(function(mintAddress){var _marketByMint$get;return getMidPrice((_marketByMint$get=marketByMint.get(mintAddress))===null||_marketByMint$get===void 0?void 0:_marketByMint$get.marketInfo.address.toBase58(),mintAddress);},[marketByMint]);var subscribeToMarket=useCallback(function(mintAddress){var info=marketByMint.get(mintAddress);var market=cache.get((info===null||info===void 0?void 0:info.marketInfo.address.toBase58())||\"\");if(!market){return function(){};}// TODO: get recent volume\nvar bid=market.info.bids.toBase58();var ask=market.info.asks.toBase58();accountsToObserve.set(bid,(accountsToObserve.get(bid)||0)+1);accountsToObserve.set(ask,(accountsToObserve.get(ask)||0)+1);// TODO: add event queue to query for last trade\nreturn function(){accountsToObserve.set(bid,(accountsToObserve.get(bid)||0)-1);accountsToObserve.set(ask,(accountsToObserve.get(ask)||0)-1);// cleanup\n_toConsumableArray(accountsToObserve.keys()).forEach(function(key){if((accountsToObserve.get(key)||0)<=0){accountsToObserve.delete(key);}});};},[marketByMint,accountsToObserve]);var precacheMarkets=useCallback(function(mints){var newMints=_toConsumableArray(new Set([].concat(_toConsumableArray(marketMints),_toConsumableArray(mints))).values());if(marketMints.length!==newMints.length){setMarketMints(newMints);}},[setMarketMints,marketMints]);useEffect(function(){precacheMarkets(userAccounts.map(function(a){return a.info.mint.toBase58();}));},[userAccounts,precacheMarkets]);return/*#__PURE__*/React.createElement(MarketsContext.Provider,{value:{midPriceInUSD:midPriceInUSD,marketEmitter:marketEmitter,accountsToObserve:accountsToObserve,marketByMint:marketByMint,subscribeToMarket:subscribeToMarket,precacheMarkets:precacheMarkets}},children);}export var useMarkets=function useMarkets(){var context=useContext(MarketsContext);return context;};export var useMidPriceInUSD=function useMidPriceInUSD(mint){var _ref5=useContext(MarketsContext),midPriceInUSD=_ref5.midPriceInUSD,subscribeToMarket=_ref5.subscribeToMarket,marketEmitter=_ref5.marketEmitter;var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),price=_useState4[0],setPrice=_useState4[1];useEffect(function(){var subscription=subscribeToMarket(mint);var update=function update(){if(midPriceInUSD){setPrice(midPriceInUSD(mint));}};update();var dispose=marketEmitter.onMarket(update);return function(){subscription();dispose();};},[midPriceInUSD,mint,marketEmitter,subscribeToMarket]);return{price:price,isBase:price===1.0};};export var usePrecacheMarket=function usePrecacheMarket(){var context=useMarkets();return context.precacheMarkets;};var bbo=function bbo(bidsBook,asksBook){var bestBid=bidsBook.getL2(1);var bestAsk=asksBook.getL2(1);if(bestBid.length>0&&bestAsk.length>0){return(bestBid[0][0]+bestAsk[0][0])/2.0;}return 0;};var getMidPrice=function getMidPrice(marketAddress,mintAddress){var _cache$get,_cache$get2,_cache$get3,_cache$get4;var SERUM_TOKEN=TOKEN_MINTS.find(function(a){return a.address.toBase58()===mintAddress;});if(STABLE_COINS.has((SERUM_TOKEN===null||SERUM_TOKEN===void 0?void 0:SERUM_TOKEN.name)||\"\")){return 1.0;}if(!marketAddress){return 0.0;}var marketInfo=cache.get(marketAddress);if(!marketInfo){return 0.0;}var decodedMarket=marketInfo.info;var baseMintDecimals=((_cache$get=cache.get(decodedMarket.baseMint))===null||_cache$get===void 0?void 0:_cache$get.info.decimals)||0;var quoteMintDecimals=((_cache$get2=cache.get(decodedMarket.quoteMint))===null||_cache$get2===void 0?void 0:_cache$get2.info.decimals)||0;var market=new Market(decodedMarket,baseMintDecimals,quoteMintDecimals,undefined,decodedMarket.programId);var bids=(_cache$get3=cache.get(decodedMarket.bids))===null||_cache$get3===void 0?void 0:_cache$get3.info;var asks=(_cache$get4=cache.get(decodedMarket.asks))===null||_cache$get4===void 0?void 0:_cache$get4.info;if(bids&&asks){var bidsBook=new Orderbook(market,bids.accountFlags,bids.slab);var asksBook=new Orderbook(market,asks.accountFlags,asks.slab);return bbo(bidsBook,asksBook);}return 0;};var refreshAccounts=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(connection,keys){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(keys.length===0)){_context3.next=2;break;}return _context3.abrupt(\"return\",[]);case 2:return _context3.abrupt(\"return\",getMultipleAccounts(connection,keys,\"single\").then(function(_ref7){var keys=_ref7.keys,array=_ref7.array;return array.map(function(item,index){var address=keys[index];return cache.add(new PublicKey(address),item);});}));case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function refreshAccounts(_x,_x2){return _ref6.apply(this,arguments);};}();","map":null,"metadata":{},"sourceType":"module"}